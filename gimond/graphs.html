<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Gmetad's metrics</title>
        <link rel="stylesheet" href="stylesheet.css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>

        <script type="text/javascript">
        
            var sent_data, cpu_data;
            var sent_chart, cpu_chart;
            var interval;
            var timerId = null;
            var timespawn;
            var tmpsentallvar, tmprrdtoolvar, tmprrdcachedvar, tmpgraphitevar, tmpmemcachedvar, tmpriemannvar;

            /* Google charts code */
            
            google.load("visualization", "1", {packages:["corechart"]});
            google.setOnLoadCallback(setVars);

            function setVars(){
                sent_chart = new google.visualization.LineChart(document.getElementById('Sent'));
                cpu_chart = new google.visualization.LineChart(document.getElementById('Cpu'));
                sent_data = [["Date", "All", "Rrdtool", "Rrdcached", "Graphite","Memcached","Riemann"]];
                cpu_data = [["Date", "User", "Nice", "System", "Idle"]];
                tmpsentallvar = [0, 0]; tmprrdtoolvar = [0, 0];
                tmprrdcachedvar = [0, 0]; tmpgraphitevar = [0, 0];
                tmpmemcachedvar = [0, 0]; tmpriemannvar = [0, 0];
            }
            function drawChart(name, metrics_data){
                var last_time = metrics_data[metrics_data.length - 1][0].getTime() - timespawn;
                var i = 1;
                //need minimum of 2 points for a line.
                for(;i<metrics_data.length-1;i++){
                    if(last_time <= metrics_data[i][0].getTime()){
                        break;
                    }
                }
                    metrics_data.splice(1,i-1);//array is sorted!
                var options = {
                    title: name,
                    width: 900,
                    height: 120,
                    hAxis: {viewWindow: {min: metrics_data[1][0], max: new Date(metrics_data[1][0].getTime() + timespawn)}}
                };
                var data = google.visualization.arrayToDataTable(metrics_data);
                switch (name){
                    case "Sent":
                        sent_chart.draw(data, options);
                    break;
                    case "Cpu":
                        cpu_chart.draw(data, options);
                    break;
                    default:
                    break;
                }
            }
            /* End Google charts code */
               
            function getMetrics(){
                var Gmetad = "http://" + window.location.hostname + ":8652/status";
                $.ajax({
                    type: "GET",
                    url: Gmetad,
                    dataType: "jsonp",
                    crossDomain: true,
                    contentType: "application/json",
                    jsonpCallback: "jsonCallback",
                    error: function(data, textStatus, jqXHR) { alert("Update crashed, please reload the page..."); console.log(textStatus + " " + jqXHR.responseText);}
                    /* If the logged error is "parsererror undefined", then the ajax() call couldn't parse the json data
                    because there was a conflict with another call to ajax(), and sometimes the metrics won't update anymore. */
                });
            }
            
            /* Example of a chart with a delta */
            function jsonCallback(data){
                sent_data.push([new Date(data["stattime"]/1000),
                                   ((data["metrics"]["sent"]["all"]["num"] - tmpsentallvar[0])/
                                   ((data["metrics"]["sent"]["all"]["totalMillis"] - tmpsentallvar[1])/interval)),
                                   ((data["metrics"]["sent"]["rrdtool"]["num"] - tmprrdtoolvar[0])/
                                   ((data["metrics"]["sent"]["rrdtool"]["totalMillis"] - tmprrdtoolvar[1])/interval)),
                                   ((data["metrics"]["sent"]["rrdcached"]["num"] - tmprrdcachedvar[0])/
                                   ((data["metrics"]["sent"]["rrdcached"]["totalMillis"] - tmprrdcachedvar[1])/interval)),
                                   ((data["metrics"]["sent"]["graphite"]["num"] - tmpgraphitevar[0])/
                                   ((data["metrics"]["sent"]["graphite"]["totalMillis"] - tmpgraphitevar[1])/interval)),
                                   ((data["metrics"]["sent"]["memcached"]["num"] - tmpmemcachedvar[0])/
                                   ((data["metrics"]["sent"]["memcached"]["totalMillis"] - tmpmemcachedvar[1])/interval)),
                                   ((data["metrics"]["sent"]["riemann"]["num"] - tmpriemannvar[0])/
                                   ((data["metrics"]["sent"]["riemann"]["totalMillis"] - tmpriemannvar[1])/interval))
                                 ]);
                tmpsentallvar[0] = data["metrics"]["sent"]["all"]["num"];
                tmprrdtoolvar[0] = data["metrics"]["sent"]["rrdtool"]["num"];
                tmprrdcachedvar[0] = data["metrics"]["sent"]["rrdcached"]["num"];
                tmpgraphitevar[0] = data["metrics"]["sent"]["graphite"]["num"];
                tmpmemcachedvar[0] = data["metrics"]["sent"]["memcached"]["num"];
                tmpriemannvar[0] = data["metrics"]["sent"]["riemann"]["num"];
                
                tmpsentallvar[1] = data["metrics"]["sent"]["all"]["totalMillis"];
                tmprrdtoolvar[1] = data["metrics"]["sent"]["rrdtool"]["totalMillis"];
                tmprrdcachedvar[1] = data["metrics"]["sent"]["rrdcached"]["totalMillis"];
                tmpgraphitevar[1] = data["metrics"]["sent"]["graphite"]["totalMillis"];
                tmpmemcachedvar[1] = data["metrics"]["sent"]["memcached"]["totalMillis"];
                tmpriemannvar[1] = data["metrics"]["sent"]["riemann"]["totalMillis"];

                drawChart('Sent', sent_data);
                /* End example */
                
                /* Example of a "normal" chart */
                cpu_data.push([new Date(data["stattime"]/1000),
                                   data["metrics"]["cpu"]["cpu_user"],
                                   data["metrics"]["cpu"]["cpu_nice"],
                                   data["metrics"]["cpu"]["cpu_system"],
                                   data["metrics"]["cpu"]["cpu_idle"]
                                 ]);
                                 
                drawChart('Cpu', cpu_data);
                /* End example */
            }

            function retrieveDropVal(txt){
                var e = document.getElementById(txt);
                return e.options[e.selectedIndex].value;
            }
            function updateMetrics(){
                if(document.getElementById("update").value == "Update"){
                    interval = retrieveDropVal("interval") * 1000;//sec
                    timespawn = retrieveDropVal("timespawn") * 60000;//min
                    document.getElementById("update").value = "Stop";
                    $('#update').text("Stop");
                    getMetrics();
                    timerId = setInterval(getMetrics, interval);
            
                }else{
                    document.getElementById("update").value = "Update";
                    $('#update').text("Update");
                    setVars();
                    clearTimeout(timerId);
                }
            }
            
        </script>
    </head>
    
    <body>
    
    <!-- Graphs -->
    <div id="Sent" style="height: 120px; width: 900px; "></div>
    <div id="Cpu" style="height: 120px; width: 900px; "></div>
    <!--End Graphs -->
    
    <div id="buttons">
        <button type="button" id="update" value="Update" onclick="updateMetrics()">Update</button>

        <label>
            <select id="interval">
                <option value=10>10</option>
                <option value=15>15</option>
                <option value=30>30</option>
                <option value=60>60</option>
            </select>
            Interval (s)
        </label>

        <label>
            <select id="timespawn">
                <option value=10>10</option>
                <option value=20>20</option>
                <option value=30>30</option>
                <option value=60>60</option>
                <option value=120>120</option>
            </select>
            Timespawn (min)
        </label>
    </div>
    
    </body>
</html>  
